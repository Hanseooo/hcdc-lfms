DROP PROCEDURE IF EXISTS resolve_report_and_log(INTEGER, UUID, UUID);

CREATE OR REPLACE PROCEDURE resolve_report_and_log(
    p_report_id INTEGER,
    p_owner_id UUID,
    p_claimant_id UUID
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_report_title TEXT;
    v_owner_name TEXT;
    v_claimant_name TEXT;
BEGIN
    -- Lock the report row
    PERFORM 1 FROM reports_report WHERE id = p_report_id FOR UPDATE;
    
    -- Get the report title
    SELECT 
        CASE
            WHEN r.type = 'lost' THEN li.item_name
            WHEN r.type = 'found' THEN fi.item_name
            ELSE 'Unknown Item'
        END
    INTO v_report_title
    FROM reports_report r
    LEFT JOIN reports_lostitem li ON li.report_id = r.id
    LEFT JOIN reports_founditem fi ON fi.report_id = r.id
    WHERE r.id = p_report_id;
    
    IF v_report_title IS NULL THEN
        RAISE EXCEPTION 'Report % not found or has no item name', p_report_id;
    END IF;
    
    -- Update report status
    UPDATE reports_report
    SET status = 'resolved'
    WHERE id = p_report_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Report with id % not found', p_report_id;
    END IF;
    
    -- Get user names
    SELECT CONCAT(first_name, ' ', last_name)
    INTO v_owner_name
    FROM accounts_user
    WHERE id = p_owner_id;
    
    SELECT CONCAT(first_name, ' ', last_name)
    INTO v_claimant_name
    FROM accounts_user
    WHERE id = p_claimant_id;
    
    -- Insert into log
    INSERT INTO reports_reportresolutionlog (
        report_id,
        resolved_by_id,
        claimed_by_id,
        receiver_name,
        giver_name,
        report_title,
        date_resolved
    )
    VALUES (
        p_report_id,
        p_owner_id,
        p_claimant_id,
        v_owner_name,
        v_claimant_name,
        v_report_title,
        NOW()
    );
    
    -- Explicit commit
    COMMIT;
END;
$$;


--UDF!!!

CREATE OR REPLACE FUNCTION get_unread_notification_count(p_user_id INTEGER)
RETURNS INTEGER AS $$
DECLARE
    unread_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO unread_count
    FROM notifications_notification
    WHERE user_id = p_user_id AND is_read = FALSE;

    RETURN unread_count;
END;
$$ LANGUAGE plpgsql;


--TRIGGER!!!


DROP TRIGGER IF EXISTS trg_log_claim_activity ON reports_notification;
DROP FUNCTION IF EXISTS log_claim_activity();

-- Create new trigger function for report resolution
CREATE OR REPLACE FUNCTION log_report_resolution()
RETURNS TRIGGER AS $$
DECLARE
    v_user_role TEXT;
BEGIN
    -- Get the user's role from accounts_user
    SELECT user_type
    INTO v_user_role
    FROM accounts_user
    WHERE id = NEW.resolved_by_id;

    -- Insert into activity log
    INSERT INTO activity_logs (
        user_id,
        role,
        report_id,
        action,
        created_at
    )
    VALUES (
        NEW.resolved_by_id,
        v_user_role,
        NEW.report_id,
        CONCAT(NEW.giver_name, ' gave ', NEW.report_title, ' to ', NEW.receiver_name),
        NOW()
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger on the resolution log table
CREATE TRIGGER trg_log_report_resolution
AFTER INSERT ON reports_reportresolutionlog
FOR EACH ROW
EXECUTE FUNCTION log_report_resolution();